<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHC Digital Twin - LangGraph Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .agent-card { transition: all 0.3s ease; }
        .agent-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .agent-card.selected { ring: 2px solid #3B82F6; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-green-700">üåø Green Hill Canarias Digital Twin</h1>
                    <div class="flex items-center space-x-4 text-sm">
                        <span id="connection-status" class="px-3 py-1 bg-green-100 text-green-700 rounded-full">Connected ‚úÖ</span>
                        <span>Mode: Live Production</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Status Dashboard -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ü§ñ AI Executive Team Dashboard</h2>
                <p class="text-sm text-gray-600 mb-2">Powered by LangGraph Cloud Deployment</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-600">üîó Assistant ID: <code class="text-xs bg-gray-100 px-1">4cc9f4b5-6725-5394-98ba-5f55b15cd94f</code></p>
                    </div>
                    <div>
                        <p class="text-gray-600">üìä LangSmith Tracing: <span id="tracing-status" class="text-green-600 font-semibold">Active</span></p>
                        <p class="text-gray-600 text-xs mt-1">Thread: <span id="current-thread" class="font-mono">Creating...</span></p>
                    </div>
                </div>
            </div>

            <!-- Agent Selection Grid -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Select Your AI Executive</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="agent-card bg-blue-50 p-4 rounded-lg cursor-pointer text-center" onclick="selectAgent('ceo_digital_twin')" id="agent-ceo">
                        <div class="text-2xl mb-2">üëë</div>
                        <div class="font-semibold text-sm">CEO Digital Twin</div>
                        <div class="text-xs text-gray-600">Strategic Leadership</div>
                    </div>
                    <div class="agent-card bg-green-50 p-4 rounded-lg cursor-pointer text-center" onclick="selectAgent('cfo_agent')" id="agent-cfo">
                        <div class="text-2xl mb-2">üí∞</div>
                        <div class="font-semibold text-sm">CFO Agent</div>
                        <div class="text-xs text-gray-600">Financial Analysis</div>
                    </div>
                    <div class="agent-card bg-purple-50 p-4 rounded-lg cursor-pointer text-center" onclick="selectAgent('coo_agent')" id="agent-coo">
                        <div class="text-2xl mb-2">‚öôÔ∏è</div>
                        <div class="font-semibold text-sm">COO Agent</div>
                        <div class="text-xs text-gray-600">Operations</div>
                    </div>
                    <div class="agent-card bg-yellow-50 p-4 rounded-lg cursor-pointer text-center" onclick="selectAgent('agricultural_intelligence')" id="agent-agri">
                        <div class="text-2xl mb-2">üå±</div>
                        <div class="font-semibold text-sm">Agricultural AI</div>
                        <div class="text-xs text-gray-600">Crop Intelligence</div>
                    </div>
                    <div class="agent-card bg-teal-50 p-4 rounded-lg cursor-pointer text-center" onclick="selectAgent('sustainability_agent')" id="agent-sustain">
                        <div class="text-2xl mb-2">‚ôªÔ∏è</div>
                        <div class="font-semibold text-sm">Sustainability</div>
                        <div class="text-xs text-gray-600">ESG Metrics</div>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    Selected Agent: <span id="selected-agent" class="font-semibold">CEO Digital Twin</span>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Executive Consultation</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="user-input" class="flex-1 p-3 border rounded-lg"
                           placeholder="Ask your question..." onkeypress="if(event.key==='Enter') sendToLangGraph()">
                    <button onclick="sendToLangGraph()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        Send to LangGraph
                    </button>
                </div>

                <div id="response" class="p-4 bg-gray-50 rounded-lg min-h-[200px]">
                    <p class="text-gray-500">Your AI executive's response will appear here...</p>
                </div>

                <div class="mt-4 flex justify-between items-center text-sm">
                    <div id="error-details" class="text-red-600"></div>
                    <div id="langgraph-status" class="text-gray-600"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // LangGraph Configuration - WORKING WITH CORRECT FORMAT
        const ASSISTANT_ID = '4cc9f4b5-6725-5394-98ba-5f55b15cd94f';
        const LANGGRAPH_BASE_URL = 'https://dgt-1bf5f8c56c9c5dcd9516a1ba62c5ebf1.us.langgraph.app';
        const LANGGRAPH_API_KEY = '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';

        let currentAgent = 'ceo_digital_twin';
        let currentThreadId = null;

        // Create a thread for the session
        async function createThread() {
            try {
                const response = await fetch(`${LANGGRAPH_BASE_URL}/threads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': LANGGRAPH_API_KEY,
                    },
                    body: JSON.stringify({
                        assistant_id: ASSISTANT_ID
                    })
                });

                if (response.ok) {
                    const threadData = await response.json();
                    currentThreadId = threadData.thread_id;
                    document.getElementById('current-thread').textContent = currentThreadId.substring(0, 8) + '...';
                    console.log('‚úÖ Thread created:', currentThreadId);
                    return currentThreadId;
                } else {
                    throw new Error(`Thread creation failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Thread creation error:', error);
                document.getElementById('current-thread').textContent = 'Failed';
                return null;
            }
        }

        // Agent selection with proper visual feedback
        function selectAgent(agent) {
            currentAgent = agent;
            
            // Update selected agent display
            const agentNames = {
                'ceo_digital_twin': 'CEO Digital Twin',
                'cfo_agent': 'CFO Agent', 
                'coo_agent': 'COO Agent',
                'agricultural_intelligence': 'Agricultural AI',
                'sustainability_agent': 'Sustainability Agent'
            };
            document.getElementById('selected-agent').textContent = agentNames[agent];

            // Update visual selection
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.agent-card').classList.add('selected');
        }

        async function sendToLangGraph() {
            const input = document.getElementById('user-input').value;
            const responseDiv = document.getElementById('response');
            const errorDiv = document.getElementById('error-details');
            const statusDiv = document.getElementById('langgraph-status');

            if (!input.trim()) {
                alert('Please enter a question');
                return;
            }

            // Ensure we have a thread
            if (!currentThreadId) {
                statusDiv.innerHTML = 'üßµ Creating thread...';
                await createThread();
                if (!currentThreadId) {
                    errorDiv.innerHTML = '‚ùå Could not create thread';
                    return;
                }
            }

            responseDiv.innerHTML = '<div class="text-gray-500 animate-pulse">ü§ñ Processing with LangGraph Cloud...</div>';
            errorDiv.innerHTML = '';
            statusDiv.innerHTML = '‚è≥ Sending request...';

            try {
                // CORRECTED PAYLOAD FORMAT - Using "question" and "source_type"
                const response = await fetch(`${LANGGRAPH_BASE_URL}/threads/${currentThreadId}/runs/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': LANGGRAPH_API_KEY,
                    },
                    body: JSON.stringify({
                        assistant_id: ASSISTANT_ID,
                        input: {
                            question: input,
                            source_type: "public",
                            agent_type: currentAgent
                        },
                        metadata: {
                            agent_type: currentAgent,
                            source: "github_pages_live"
                        },
                        stream_mode: "values"
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('LangGraph error:', response.status, errorText);
                    
                    // If thread not found, create new one and retry
                    if (response.status === 404 && errorText.includes('Thread')) {
                        console.log('Thread not found, creating new one...');
                        await createThread();
                        if (currentThreadId) {
                            // Retry with new thread
                            return sendToLangGraph();
                        }
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let finalResponse = '';
                let eventCount = 0;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('event:')) continue;
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6).trim();
                                if (jsonStr === '[DONE]' || !jsonStr) continue;
                                
                                const data = JSON.parse(jsonStr);
                                eventCount++;
                                console.log(`Event ${eventCount}:`, data);
                                
                                // Extract content from LangGraph response - CORRECTED parsing
                                if (data.final_answer && !data.final_answer.includes('Error:')) {
                                    finalResponse = data.final_answer;
                                } else if (data.green_hill_response) {
                                    finalResponse = data.green_hill_response;
                                } else if (data.messages && data.messages.length > 0) {
                                    const lastMessage = data.messages[data.messages.length - 1];
                                    if (lastMessage && lastMessage.content) {
                                        finalResponse = lastMessage.content;
                                    }
                                } else if (data.content) {
                                    finalResponse = data.content;
                                }
                            } catch (e) {
                                console.warn('Parse error:', e, 'Line:', line);
                            }
                        }
                    }
                }

                console.log(`‚úÖ Processed ${eventCount} events, response length: ${finalResponse.length}`);

                if (finalResponse && finalResponse.trim() && !finalResponse.includes('Error:')) {
                    displayResponse(finalResponse);
                    statusDiv.innerHTML = '‚úÖ Response from LangGraph';
                } else {
                    throw new Error('No valid response content received');
                }

                document.getElementById('user-input').value = '';

            } catch (error) {
                console.error('LangGraph Error:', error);

                // Enhanced fallback with real GHC data
                const fallbackResponses = {
                    'ceo_digital_twin': `**Strategic Overview - Green Hill Canarias**

As CEO, I'm pleased to address your question: "${input}"

**Current Performance:**
- Revenue: ‚Ç¨3.2M (Q3 2024, 32% YoY growth)
- EBITDA Margin: 22% and improving
- Operations: 750 hectares across Gran Canaria & Tenerife
- Team: 180 employees including 45 engineers

**Strategic Priorities:**
- Series A funding: ‚Ç¨8M target for technology expansion
- Market expansion to mainland Spain and North Africa  
- Carbon-neutral operations (achieved Q4 2024)
- Precision agriculture technology integration

This aligns with our sustainable growth strategy and operational excellence framework.`,

                    'cfo_agent': `**Financial Analysis - Green Hill Canarias**

Regarding "${input}", here's our financial perspective:

**Key Metrics (Q3 2024):**
- Revenue: ‚Ç¨3.2M (32% YoY growth)
- EBITDA Margin: 22% with operational efficiency gains
- Cash Flow: Positive since Q2 2024
- Funding Target: ‚Ç¨8M Series A for expansion

**Financial Health:**
- Strong growth trajectory with sustainable margins
- Technology investments showing positive ROI
- Clear path to profitability scaling
- ESG compliance attracting premium valuations

Our financial position supports aggressive growth while maintaining fiscal discipline.`,

                    'coo_agent': `**Operations Analysis - Green Hill Canarias**

From an operational standpoint regarding "${input}":

**Operational Excellence:**
- 750 hectares under management (Gran Canaria & Tenerife)
- 12,000 tons annual production capacity
- 98.5% quality certification rate
- 180 employees including 45 agricultural engineers

**Technology Integration:**
- IoT sensors across all operations
- AI-driven analytics for yield optimization  
- 35% water usage reduction through smart irrigation
- 15 distribution partners across Spain

Our operational efficiency drives both sustainability and profitability.`,

                    'agricultural_intelligence': `**Agricultural Intelligence Report**

Analyzing "${input}" from our precision agriculture perspective:

**Performance Metrics:**
- 23% yield improvement through AI optimization
- 35% water usage reduction via smart irrigation
- 50% biodiversity increase through regenerative practices
- Real-time monitoring across 750 hectares

**Technology Stack:**
- IoT sensor networks for soil and weather monitoring
- AI-driven crop health analysis
- Predictive modeling for optimal harvest timing
- Automated irrigation and nutrient management

Our precision agriculture approach maximizes both yield and sustainability.`,

                    'sustainability_agent': `**Sustainability Impact Report**

Addressing "${input}" from our ESG perspective:

**Achievements:**
- Carbon neutral operations (Q4 2024 - 6 months ahead)
- 85% renewable energy coverage (solar/wind)
- 35% water usage reduction through AI optimization
- 50% biodiversity increase via regenerative agriculture

**Initiatives:**
- Comprehensive ESG reporting framework
- Carbon footprint tracking and reduction
- Renewable energy integration projects
- Biodiversity conservation programs

Our sustainability leadership creates competitive advantage and investor appeal.`
                };

                displayFallbackResponse(fallbackResponses[currentAgent] || fallbackResponses['ceo_digital_twin'], error.message);
                errorDiv.innerHTML = `‚ö†Ô∏è Using enhanced local response. Error: ${error.message}`;
                statusDiv.innerHTML = 'üü° Local mode';
            }
        }

        function displayResponse(content) {
            const responseDiv = document.getElementById('response');
            responseDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <span class="font-semibold">${currentAgent.replace(/_/g, ' ').toUpperCase()}</span>
                        <span class="text-xs">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="prose prose-sm max-w-none">
                        ${marked.parse ? marked.parse(content) : content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }

        function displayFallbackResponse(content, errorMsg) {
            const responseDiv = document.getElementById('response');
            responseDiv.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-yellow-800">‚ö†Ô∏è Using enhanced knowledge base (LangGraph temporarily unavailable)</p>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <span class="font-semibold">${currentAgent.replace(/_/g, ' ').toUpperCase()}</span>
                        <span class="text-xs">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="prose prose-sm max-w-none">
                        ${marked.parse ? marked.parse(content) : content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }

        // Initialize on load
        window.onload = async function() {
            console.log('üåø GHC Digital Twin initialized');
            console.log('ü§ñ Assistant ID:', ASSISTANT_ID);
            console.log('üîó LangGraph URL:', LANGGRAPH_BASE_URL);
            console.log('üîë API Key configured:', LANGGRAPH_API_KEY ? '‚úÖ' : '‚ùå');
            
            document.getElementById('langgraph-status').innerHTML = 'üü¢ Ready';
            
            // Create initial thread
            await createThread();
            
            // Select CEO by default
            document.getElementById('agent-ceo').click();
        };
    </script>

    <!-- Include marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>